# Helloworld应用

## 接口定义文件

Slice (Specification Language for Ice) 是Ice的接口定义语言，用于定义一个语言中立的RPC服务接口，通过slice2*工具转换成各语言接口实现。

例如实现一个简单的打印服务应用，slice定义如下

````
//Printer.ice
module Demo {
    interface Printer {
        void printString(string s);
    };
};
````

## C++ Example

### 编译C++接口客户端proxies和服务端skeletons

````
$slice2cpp Printer.ice
$ls
Printer.h
Printer.cpp
````

### Printer服务端代码实现

````c++
#include <Ice/Ice.h>
#include <Printer.h>
 
using namespace std;
using namespace Demo;
 
class PrinterI : public Printer {
public:
    virtual void printString(const string& s, const Ice::Current&);
};
 
void PrinterI::printString(const string& s, const Ice::Current&) {
    cout << s << endl;
}
 
int main(int argc, char* argv[]) {
    int status = 0;
    Ice::CommunicatorPtr ic;
    try {
        ic = Ice::initialize(argc, argv);
        Ice::ObjectAdapterPtr adapter =
            ic->createObjectAdapterWithEndpoints("PrinterAdapter", "default -p 10000");
        Ice::ObjectPtr object = new PrinterI;
        adapter->add(object, ic->stringToIdentity("Printer"));
        adapter->activate();
        ic->waitForShutdown();
    } catch (const Ice::Exception& e) {
        cerr << e << endl;
        status = 1;
    } catch (const char* msg) {
        cerr << msg << endl;
        status = 1;
    }
    if (ic) {
        try {
            ic->destroy();
        } catch (const Ice::Exception& e) {
            cerr << e << endl;
            status = 1;
        }
    }
    return status;
}
````

- Ice会为每个接口增加一个Ice::Current参数，这个参数包含请求的相关信息，如请求id、连接和上下文Context等等，相信参考文档https://doc.zeroc.com/display/Ice36/The+Current+Object
- Ice大量使用智能指针管理对象生命周期
- Ice::initialize初始化Ice运行时环境
- createObjectAdapterWithEndpoints创建ObjectAdapter并指定Adapter监听端口和默认协议TCP/IP
- 创建Servant对象加入到adapter并指定对象的identity Printer，然后激活Servant(Ice中所有接口都叫Object对象，对象的实现叫Servant)

### 编译服务端代码

````
$c++ -g -pthread -I./ `pkg-config --cflags ice` `pkg-config --libs ice` Printer.cpp Server.cpp -o server -lIce -lIceUtil
````

### 运行服务端代码

````
$./server
````

### Printer客户端代码

````c++
#include <Ice/Ice.h>
#include <Printer.h>
 
using namespace std;
using namespace Demo;
 
int main(int argc, char* argv[]) {
    int status = 0;
    Ice::CommunicatorPtr ic;
    try {
        ic = Ice::initialize(argc, argv);
        Ice::ObjectPrx base = ic->stringToProxy("Printer:default -p 10000");
        PrinterPrx printer = PrinterPrx::checkedCast(base);
        if (!printer)
            throw "Invalid proxy";
 
        printer->printString("Hello World!");
    } catch (const Ice::Exception& ex) {
        cerr << ex << endl;
        status = 1;
    } catch (const char* msg) {
        cerr << msg << endl;
        status = 1;
    }
    if (ic)
        ic->destroy();
    return status;
}
````
- stringToProxy指定Endpoint地址和对象identity创建远程对象代理
- 通过PrinterPrx::checkedCast方法down-cast类型转换(checkedCast会向服务端发送消息进行类型检查而uncheckCast则不进行类检查)
- printString接口调用

### 编译客户端代码

````
$c++ -g -pthread -I./ `pkg-config --cflags ice` `pkg-config --libs ice` Printer.cpp Client.cpp -o client -lIce -lIceUtil
````

### 运行客户端代码

````
$./client
````



## Java Example

### 编译Java接口客户端proxies和服务端skeletons

````
$ mkdir generated
$ slice2java --output-dir generated Printer.ice
````

### Printer服务端代码实现

````java
//To implement our Printer interface, Demo._PrinterDisp generated by slice2java
public class PrinterI extends Demo._PrinterDisp {
    public void printString(String s, Ice.Current current) {
        System.out.println(s);
    }
}
````

- Ice会为每个接口增加一个Ice::Current参数，这个参数包含请求的相关信息，如请求id、连接和上下文Context等等，相信参考文档https://doc.zeroc.com/display/Ice36/The+Current+Object

````java
//server code implement
public class Server {
    public static void main(String[] args) {
        int status = 0;
        Ice.Communicator ic = null;
        try {
            ic = Ice.Util.initialize(args);
            Ice.ObjectAdapter adapter =
                ic.createObjectAdapterWithEndpoints("PrinterAdapter", "default -p 10000");
            Ice.Object object = new PrinterI();
            adapter.add(object, ic.stringToIdentity("Printer"));
            adapter.activate();
            ic.waitForShutdown();
        } catch (Ice.LocalException e) {
            e.printStackTrace();
            status = 1;
        } catch (Exception e) {
            System.err.println(e.getMessage());
            status = 1;
        }
        if (ic != null) {
            // Clean up
            try {
                ic.destroy();
            } catch (Exception e) {
                System.err.println(e.getMessage());
                status = 1;
            }
        }
        System.exit(status);
    }
}
````

- Ice.Util.initialize初始化Ice运行时环境
- createObjectAdapterWithEndpoints创建ObjectAdapter并指定Adapter监听端口和默认协议TCP/IP
- 创建Servant对象加入到adapter并指定对象的identity Printer，然后激活Servant(Ice中所有接口都叫Object对象，对象的实现叫Servant)

### 编译服务端代码

````
$ mkdir classes
$ javac -d classes -classpath classes:$ICE_HOME/lib/Ice.jar \
Server.java PrinterI.java generated/Demo/*.java
````

### 运行服务端代码

````
$ java -classpath classes:$ICE_HOME/lib/Ice.jar Server
````

### Printer客户端代码实现

````java
public class Client {
    public static void main(String[] args) {
        int status = 0;
        Ice.Communicator ic = null;
        try {
            ic = Ice.Util.initialize(args);
            Ice.ObjectPrx base = ic.stringToProxy("Printer:default -p 10000");
            Demo.PrinterPrx printer = Demo.PrinterPrxHelper.checkedCast(base);
            if (printer == null)
                throw new Error("Invalid proxy");
 
            printer.printString("Hello World!");
        } catch (Ice.LocalException e) {
            e.printStackTrace();
            status = 1;
        } catch (Exception e) {
            System.err.println(e.getMessage());
            status = 1;
        }
        if (ic != null) {
            // Clean up
            //
            try {
                ic.destroy();
            } catch (Exception e) {
                System.err.println(e.getMessage());
                status = 1;
            }
        }
        System.exit(status);
    }
}
````

- stringToProxy指定Endpoint地址和对象identity创建远程对象代理
- 通过PrinterPrxHelper.checkedCast方法down-cast类型转换(checkedCast会向服务端发送消息进行类型检查而uncheckCast则不进行类检查)
- printString接口调用

### 运行客户端代码

````
$ java -classpath classes:$ICE_HOME/lib/Ice.jar Client
````

